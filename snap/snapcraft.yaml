name: qalculate
version: '3.8.0'
summary: The ultimate desktop calculator
description: |
  Qalculate! is a multi-purpose cross-platform desktop calculator. It is simple
  to use but provides power and versatility normally reserved for complicated
  math packages, as well as useful tools for everyday needs (such as currency
  conversion and percent calculation). Features include a large library of
  customizable functions, unit calculations and conversion, physical constants,
  symbolic calculations (including integrals and equations), arbitrary precision,
  uncertainty propagation, interval arithmetic, plotting, and a user-friendly
  interface.

grade: stable
confinement: strict
base: core18

slots:
  dbus-qalculate:
    interface: dbus
    name: org.gtk.qalculate
    bus: session

apps:
  qalc:
    environment:
        DISABLE_WAYLAND: 1
        GNUPLOT_DRIVER_DIR: $SNAP/libexec/gnuplot/5.2
    command: desktop-launch qalc
    extensions: [gnome-3-28]
    plugs: [network]
  gtk:
    environment:
        DISABLE_WAYLAND: 1
        GNUPLOT_DRIVER_DIR: $SNAP/libexec/gnuplot/5.2
    command:  desktop-launch qalculate-gtk
    extensions: [gnome-3-28]
    plugs: [unity7, network, home]
  gnuplot:
    environment: 
        GNUPLOT_DRIVER_DIR: $SNAP/libexec/gnuplot/5.2
    command: desktop-launch gnuplot
    extensions: [gnome-3-28]
    plugs: [unity7, home]

parts:
  libqalculate:
    source: https://github.com/Qalculate/libqalculate.git
    source-tag: v3.8.0
    plugin: autotools
    build-packages:
      - libncurses5-dev
      - libreadline-dev
      - libcurl4-gnutls-dev
      - libicu-dev
      - libxml2-dev
      - libgmp-dev
      - libmpfr-dev
      - intltool
      - doxygen
    stage-packages:
      - libcurl3-gnutls
      - libmpfr6
      - libxml2
    override-build: |
      for p in $SNAPCRAFT_PROJECT_DIR/patches/lib/*.patch
      do
        cat $p | patch -p1
      done
      snapcraftctl build
      echo Stripping qalc
      strip $SNAPCRAFT_PART_INSTALL/bin/qalc
    prime:
      - -include
      - -lib/pkgconfig
      - -lib/*.a
      - -share/doc
      - -usr/share/doc
      - -usr/share/lintian

  qalculate-gtk:
    source: https://github.com/Qalculate/qalculate-gtk.git
    source-tag: v3.8.0
    plugin: autotools
    build-packages:
      - libgmp-dev
      - libgtk-3-dev
      - libxml2-dev
      - intltool
    override-build: |
      for p in $SNAPCRAFT_PROJECT_DIR/patches/gui/*.patch
      do
        cat $p | patch -p1
      done
      snapcraftctl build
      echo Stripping qalculate-gtk
      strip $SNAPCRAFT_PART_INSTALL/bin/qalculate-gtk
    after:
      - libqalculate
    prime:
      - -share/applications
      - -share/doc

  gnuplot:
    source: https://sourceforge.net/projects/gnuplot/files/gnuplot/5.2.8/gnuplot-5.2.8.tar.gz
    plugin: autotools
    configflags:
      - --without-gd
      - --without-libcerf
      - --without-linux-vga
      - --without-lua
      - --without-qt
      - --with-readline=gnu
      - --enable-wxwidgets
    build-packages:
      - libcairo2-dev
      - libpango1.0-dev
      - libpng-dev
      - libx11-dev
      - libxt-dev
      - pkg-config
      - zlib1g-dev
    after:
      - wxwidgets-sdk
    prime:
      - -share/applications
      - -share/doc
      - -share/man
    override-build: |
      snapcraftctl build
      echo Stripping gnuplot
      strip $SNAPCRAFT_PART_INSTALL/bin/gnuplot
      strip $SNAPCRAFT_PART_INSTALL/libexec/gnuplot/5.2/gnuplot_x11

  wxwidgets-sdk:
    plugin: nil
    stage-snaps:
      - wxwidgets-sdk-gtk3
    stage-packages:
      # Crash dialog support
      - binutils
    filesets:
      crash-dialog-support:
        - usr/bin/*addr2line
      library-shared:
        - '**/lib/**/*.so*'
    prime:
      - $crash-dialog-support
      - $library-shared

  workaround:
    plugin: nil
    stage-packages:
      - libgtk-3-0
    prime:
      - "-*"

